{% extends 'base.html.j2' %}

{% block app_content %}
<div class="container">
  <div class="card mt-3 shadow {% if not user.deposit %}border-secondary{% elif user.balance <= 0 %}border-danger{% elif user.balance <= 5 %}border-warning{% else %}border-primary{% endif %}">
    <div class="card-header">
      <h3 class="card-title {% if not user.deposit %}text-secondary{% elif user.balance <= 0 %}text-danger{% elif user.balance <= 5 %}text-warning{% else %}text-primary{% endif %}">{{ user.first_name }}{% if current_user.is_bartender and user.nickname %} "{{ user.nickname }}"{% endif %} {{ user.last_name }}{% if is_admin %} – Administrator{% elif user.is_bartender %} – Bartender{% endif %}</h3>
    </div>

    <div class="card-body">
      <div class="row">
        <div class="col-md-3 col-lg-3 mb-4" align="center">
          <!-- User picture -->
          <img src="{{ user.avatar() }}" alt="{{ user.username }}">
        </div>

        <div class="table-responsive-sm col-md-9 col-lg-9">
          <table class="table table-striped">
            <tbody>
              <tr>
                <td><strong>Username:</strong></td>
                <td>{{ user.username }}</td>
              </tr>
              <tr>
                <td><strong>Email:</strong></td>
                <td><a href="mailto:{{ user.email }}">{{ user.email }}</a></td>
              </tr>
              <tr>
                <td><strong>Age:</strong></td>
                <td>{{ age }} years old</td>
              <tr>
                <td><strong>Graduating class:</strong></td>
                <td>{% if user.grad_class != 0 %}{{ user.grad_class }}{% else %}Extern{% endif %}</td>
              </tr>
              <tr>
                <td><strong>Last drink:</strong></td>
                <td>
                  {% if user.last_drink %}
                  {{ moment(user.last_drink).fromNow() }}
                  {% else %}
                  Non-existent or reverted
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>Balance:</strong></td>
                <td>
                  <div class="progress mt-1" style="height: 18px;">
                    <div class="progress-bar bg-{% if not user.deposit %}secondary{% elif user.balance <= 0 %}danger{% elif user.balance <= 5 %}warning{% else %}primary{% endif %}" role="progressbar" aria-valuenow="{{ user.balance }}" aria-valuemin="0" aria-valuemax="50" style="width: {{ user.balance }}%; min-width: 3em; max-width: 100%">
                      {{ '%0.2f' | format(user.balance) }}€
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- User statistics -->
    <div class="container mb-4">
      <div class="card card-secondary" align="left">
        <div class="card-header">
          <h4 class="card-title {% if not user.deposit %}text-secondary{% elif user.balance <= 0 %}text-danger{% elif user.balance <= 5 %}text-warning{% else %}text-primary{% endif %}">Last transactions</h4>
        </div>
        <ul class="list-group">
          <li class="list-group-item"><span class="badge">{{ '%0.2f' | format(amount_paid) }}€</span>Amount paid</li>
          <li class="list-group-item"><span class="badge">{{ '%0.2f' | format(amount_topped_up) }}€</span>Amount topped up</li>
        </ul>
      </div>
    </div>

    {% if user.deposit or current_user.is_bartender %}
    <div class="card-footer">
      <div class="btn-toolbar justify-content-between" role="toolbar" aria-label="User button toolbar">
        {% if current_user.is_bartender and user.deposit %}
        <div class="btn-group" role="group" aria-label="User actions">
          <a class="btn {% if user.balance <= 0 %}btn-danger{% elif user.balance <= 5 %}btn-warning{% else %}btn-primary{% endif %}" href="{{ url_for('main.qrcode', username=user.username) }}" role="button"><i class="material-icons align-middle">camera_alt</i></a>
          {% include '_pay.html.j2' %}

          <!-- Top up modal button -->
          <button type="button" class="btn user-card-btn btn {% if user.balance <= 0 %}btn-danger{% elif user.balance <= 5 %}btn-warning{% else %}btn-primary{% endif %}" data-toggle="modal" data-target="#top-up-modal">
            <i class="material-icons icon align-middle">credit_card</i><span class="text">Top up</span>
          </button>

          {% include '_quick_access_item.html.j2' %}
        </div>
        {% elif current_user.is_bartender %}
        <div class="btn-group" role="group" aria-label="Deposit">
          {% include '_deposit.html.j2' %}
        </div>
        {% else %}
        <div class="btn-group" role="group" aria-label="User actions">
          <a class="btn btn-primary" href="{{ url_for('main.qrcode', username=user.username) }}" role="button"><i class="material-icons align-middle">camera_alt</i></a>
        </div>
        {% endif %}

        {% if current_user.is_bartender %}
        <div class="btn-group">
          <a class="btn btn-warning" href="{{ url_for('main.edit_profile', username=user.username) }}" role="button">
            <i class="material-icons align-middle">edit</i>
          </a>

          <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#delete-user-modal">
            <i class="material-icons align-middle">delete</i>
          </button>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block modals %}
<!-- User deletion modal -->
<div class="modal fade" id="delete-user-modal" tabindex="-1" role="dialog" aria-labelledby="delete-user-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="delete-user-modal-label">Delete user</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <i class="material-icons align-middle">close</i>
        </button>
      </div>
      <div class="modal-body">
        Delete user {{ user.first_name }} {{ user.last_name }}?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
        <a class="btn btn-primary" href="{{ url_for('main.delete_user', username=user.username) }}" role="button">Yes</a>
      </div>
    </div>
  </div>
</div>

<!-- User top up modal -->
<div class="modal fade" id="top-up-modal" tabindex="-1" role="dialog" aria-labelledby="top-up-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <form class="modal-content" action="{{ url_for('main.top_up', username=user.username) }}" method="post">
      <div class="modal-header">
        <h5 class="modal-title" id="top-up-modal-label">Top up – {{ user.first_name }} {{ user.last_name }}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <i class="material-icons align-middle">close</i>
        </button>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <label for="topUpAmount" class="sr-only">Top Up</label>
          <input class="form-control" type="number" name="amount" id="topUpAmount" step=0.01 min=0 name="amount" placeholder="Amount" aria-describedby="top-up-submit">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <input class="btn btn-primary" type="submit" value="Top up" role="button">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<!-- Populate pay dropdown -->
<script>
$(".pay-btn").each(function() {
  var pay_btn = $(this)
  var dropdown = $(pay_btn).find('.dropdown-menu')
  $.post('/get_user_products', {
    username: $(pay_btn).attr('id').replace('-pay-btn', '')
  }).done(function(response) {
    $(dropdown).append(response['html'])
  }).fail(function() {
    $(dropdown).append('Error: Could not contact server.')
  });
});
</script>
{% endblock %}
